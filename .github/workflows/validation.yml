name: Deploy to Salesforce

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Install Node 20 for the whole runner
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Install Salesforce CLI from npm (uses Node 20)
      - name: Install Salesforce CLI
        run: npm install --global @salesforce/cli

      # Authenticate Salesforce
      #- name: Authenticate to Salesforce
        #run: |
          #echo "${{ secrets.SF_AUTH_URL }}" > sfdx-auth-url.txt
          #sf auth:sfdxurl:store --sfdx-url-file sfdx-auth-url.txt --set-default-dev-hub
      - name: Authenticate to Salesforce
        run: sf org login jwt \
          --client-id ${{ secrets.SF_CONSUMER_KEY }} \
          --jwt-key-file ${{ secrets.SF_SERVER_KEY }}
          --username ${{ secrets.SF_USERNAME }} \
          --instance-url ${{ secrets.SF_LOGIN_URL }} \
          --set-default


      # Install sfdx-git-delta (now works because Node 20 is used)
      - name: Install sfdx-git-delta
        run: |
          echo y | sf plugins install sfdx-git-delta

      # Generate delta package
      - name: Generate Delta
        run: |
          sf sgd:source:delta --to "HEAD" --from "origin/main" \
            --output "." --ignore .github/workflows/ignore.txt

      # Deploy metadata
      - name: Deploy to Salesforce
        run: |
          sf project deploy start -d force-app --test-level NoTestRun
